<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ name }} - Resume Preview</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='template1/style.css') }}" />
</head>
<body>
  <!-- Top control bar (place BEFORE or AFTER your resume container in DOM, but visually overlayed) -->
<div id="top-controls" aria-hidden="false">
  <button id="back-btn" class="control-btn">‚Üê Back</button>

  <div class="download-group">
    <button id="download-btn" class="control-btn">Download ‚ñæ</button>
    <div id="download-menu" class="download-menu" role="menu" aria-hidden="true">
      <button class="download-option" data-type="pdf">Download as PDF</button>
      <button class="download-option" data-type="jpg">Download as JPG</button>
    </div>
  </div>
</div>
  <div class="resume-container" id="resume-content">

    <div class="resume-header">
      <div>
        <h1>{{ name }}</h1>
        <h2>{{ title }}</h2>
      </div>
      <div class="header-right">
        <div class="dots"></div>
        <div class="profile-img">
          {% if profile_photo %}
            <img src="{{ url_for('static', filename='uploads/' ~ profile_photo) }}" alt="Profile Picture" />
          {% else %}
            <img src="{{ url_for('static', filename='images/default.jpg') }}" alt="Default Picture" />
          {% endif %}
        </div>
      </div>
      
    </div>
    

    <div class="resume-body">
      <div class="left">
        <section>
          <h3>About Me</h3>
          <p>{{ about }}</p>
        </section>

        <section>
  {% if certs and certs|select('string')|list %}
    <h3>Certifications</h3>
    <ul>
      {% for cert in certs %}
        {% if cert.strip() %}
          <li>{{ cert }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  {% endif %}
</section>





        <section>
          <h3>Experience</h3>
          <p>{{ experience }}</p>
        </section>
      </div>

      <div class="right">
        <section>
          <h3>Skills</h3>
          <ul>
            {% for skill in skills %}
              <li>{{ skill }}</li>
            {% endfor %}
          </ul>
        </section>

        <section>
  {% if education and education|select('string')|list %}
    <h3>Education</h3>
    <ul>
      {% for edu in education %}
        {% if edu.strip() %}
          <li>{{ edu }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  {% endif %}
</section>



        <section>
    <h3>Contact</h3>
     {% if phone %}<p><i data-lucide="phone" class="icon"></i> {{ phone }}</p>{% endif %}
     {% if email %}<p><i data-lucide="mail" class="icon"></i> {{ email }}</p>{% endif %}
     {% if location %}<p><i data-lucide="map-pin" class="icon"></i> {{ location }}</p>{% endif %}
  </section>
      </div>
    </div>
    <div class="resume-footer">
  <div class="footer-dots"></div>
</div>

  </div>
  <script src="https://unpkg.com/lucide@latest"></script>
<script>
  lucide.createIcons();
  
</script>
<!-- Download & Back Button Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(() => {
  const resumeNode = document.getElementById('resume-content');
  const backBtn = document.getElementById('back-btn');
  const downloadBtn = document.getElementById('download-btn');
  const downloadMenu = document.getElementById('download-menu');

  // üîô Back Button
  if (backBtn) backBtn.addEventListener('click', () => {
   window.location.href = "{{ url_for('form_template1') }}";
  });

  // üìÇ Toggle dropdown
  downloadBtn.addEventListener('click', () => {
    downloadMenu.classList.toggle('show');
  });
  document.addEventListener('click', e => {
    if (!downloadBtn.contains(e.target) && !downloadMenu.contains(e.target)) {
      downloadMenu.classList.remove('show');
    }
  });

  // üñº Wait for all images before capture
  function waitForImages(node) {
    const imgs = node.querySelectorAll("img");
    return Promise.all(
      [...imgs].map(
        img => new Promise(res => {
          if (img.complete) res();
          else { img.onload = img.onerror = res; }
        })
      )
    );
  }

  // üì∏ Download as JPG
  async function downloadAsJpg() {
    try {
      await waitForImages(resumeNode);
      const canvas = await html2canvas(resumeNode, {
        scale: 3,
        useCORS: true,
        scrollX: 0,
        scrollY: 0,
        windowWidth: resumeNode.scrollWidth,
        windowHeight: resumeNode.scrollHeight
      });
      const link = document.createElement('a');
      link.download = 'resume.jpg';
      link.href = canvas.toDataURL('image/jpeg', 1.0);
      link.click();
    } catch (err) {
      console.error("JPG download failed:", err);
      alert("Failed to export JPG ‚Äî check console for details.");
    }
  }

  // üìÑ Download as PDF (no cropping, full width visible)
  async function downloadAsPdf() {
    try {
      console.log("Preparing precise PDF export...");
      await waitForImages(resumeNode);

      const canvas = await html2canvas(resumeNode, {
        scale: 3,
        useCORS: true,
        scrollX: 0,
        scrollY: 0,
        backgroundColor: '#ffffff',
        windowWidth: resumeNode.scrollWidth,
        windowHeight: resumeNode.scrollHeight
      });

      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // ‚úÖ Fit to full width, maintaining aspect ratio (no cropping)
      const imgWidth = pageWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let yPosition = 0;
      if (imgHeight < pageHeight) {
        yPosition = (pageHeight - imgHeight) / 2;
      }

      pdf.addImage(imgData, 'PNG', 0, yPosition, imgWidth, imgHeight);
      pdf.save('resume.pdf');
      console.log("PDF download triggered successfully.");
    } catch (err) {
      console.error("PDF export failed:", err);
      alert("Failed to export PDF ‚Äî check console for details.");
    }
  }

  // ‚ö° Handle dropdown options
  document.querySelectorAll('.download-option').forEach(btn => {
    btn.addEventListener('click', e => {
      const type = e.target.dataset.type;
      downloadMenu.classList.remove('show');
      if (type === 'pdf') downloadAsPdf();
      else if (type === 'jpg') downloadAsJpg();
    });
  });
})();
</script>

</body>
</html>
